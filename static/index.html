<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StockPro Terminal</title>
    <link rel="manifest" href="/static/manifest.json">
    <meta name="theme-color" content="#0f0f14">
    <link rel="apple-touch-icon" href="/static/icon-192.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lightweight-charts@4.2.0/dist/lightweight-charts.standalone.production.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        term: {
                            bg: '#0f0f14',
                            surface: '#16161e',
                            card: '#1a1a24',
                            border: '#2a2a3a',
                            hover: '#22222f',
                            accent: '#6366f1',
                            accentDim: '#4f46e5',
                            green: '#00c853',
                            red: '#ff1744',
                            muted: '#5c5c7a',
                            text: '#c8c8d8',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&family=Inter:wght@400;500;600;700&display=swap');
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Inter', -apple-system, sans-serif; background: #0f0f14; color: #c8c8d8; overflow: hidden; height: 100vh; }
        ::-webkit-scrollbar { width: 5px; height: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #2a2a3a; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #3a3a4a; }
        .mono { font-family: 'JetBrains Mono', monospace; }

        /* Layout */
        .app-layout {
            display: grid;
            grid-template-columns: 260px 1fr 320px;
            grid-template-rows: 48px 1fr 280px;
            height: 100vh;
            gap: 1px;
            background: #0a0a10;
        }
        .app-header { grid-column: 1 / -1; }
        .panel-left { grid-row: 2 / 4; overflow: hidden; display: flex; flex-direction: column; }
        .panel-center { overflow: hidden; display: flex; flex-direction: column; }
        .panel-right { grid-row: 2 / 4; overflow: hidden; display: flex; flex-direction: column; }
        .panel-bottom { overflow: hidden; display: flex; flex-direction: column; }

        /* Panel styling */
        .panel { background: #16161e; }
        .panel-title {
            font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.08em;
            color: #6366f1; padding: 10px 14px 6px; user-select: none;
        }

        /* Input */
        .input-dark {
            background: #0f0f14; border: 1px solid #2a2a3a; border-radius: 6px;
            color: #c8c8d8; padding: 7px 10px; font-size: 13px; width: 100%;
            transition: border-color 0.15s;
        }
        .input-dark:focus { outline: none; border-color: #6366f1; box-shadow: 0 0 0 2px rgba(99,102,241,0.15); }
        .input-dark::placeholder { color: #5c5c7a; }

        select.input-dark { cursor: pointer; appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%235c5c7a' d='M3 4.5L6 8l3-3.5H3z'/%3E%3C/svg%3E");
            background-repeat: no-repeat; background-position: right 8px center; padding-right: 26px;
        }

        /* Buttons */
        .btn-accent {
            background: #6366f1; color: white; border: none; border-radius: 6px;
            padding: 7px 16px; font-size: 12px; font-weight: 600; cursor: pointer;
            transition: all 0.15s; white-space: nowrap;
        }
        .btn-accent:hover { background: #5558e6; transform: translateY(-1px); }
        .btn-accent:active { transform: translateY(0); }
        .btn-accent:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }

        .btn-ghost {
            background: transparent; color: #5c5c7a; border: 1px solid #2a2a3a; border-radius: 6px;
            padding: 5px 10px; font-size: 11px; font-weight: 500; cursor: pointer;
            transition: all 0.15s;
        }
        .btn-ghost:hover { border-color: #6366f1; color: #c8c8d8; }
        .btn-ghost.active { background: #6366f1; color: white; border-color: #6366f1; }

        /* Watchlist item */
        .wl-item {
            display: grid; grid-template-columns: 1fr auto auto;
            align-items: center; gap: 8px;
            padding: 8px 14px; cursor: pointer;
            transition: background 0.1s; border-bottom: 1px solid #1e1e2a;
        }
        .wl-item:hover { background: #1e1e2a; }
        .wl-item.active { background: #1e1e30; border-left: 2px solid #6366f1; }
        .wl-symbol { font-size: 13px; font-weight: 600; color: #e0e0ea; }
        .wl-name { font-size: 10px; color: #5c5c7a; margin-top: 1px; }
        .wl-price { font-size: 13px; font-weight: 600; text-align: right; }
        .wl-change { font-size: 11px; text-align: right; font-weight: 500; }

        /* KPI card */
        .kpi { text-align: center; padding: 10px 8px; }
        .kpi-value { font-size: 18px; font-weight: 700; line-height: 1.2; }
        .kpi-label { font-size: 10px; color: #5c5c7a; margin-top: 3px; text-transform: uppercase; letter-spacing: 0.04em; }

        /* Trade table */
        .trade-tbl { width: 100%; font-size: 12px; border-collapse: collapse; }
        .trade-tbl th {
            position: sticky; top: 0; background: #16161e; z-index: 2;
            text-align: right; padding: 6px 8px; font-size: 10px;
            text-transform: uppercase; letter-spacing: 0.04em; color: #5c5c7a; font-weight: 600;
            border-bottom: 1px solid #2a2a3a; cursor: pointer; user-select: none;
        }
        .trade-tbl th:first-child, .trade-tbl td:first-child { text-align: left; }
        .trade-tbl td { padding: 5px 8px; border-bottom: 1px solid #1e1e2a; }
        .trade-tbl tbody tr:hover { background: #1e1e2a; }

        .text-up { color: #00c853; }
        .text-down { color: #ff1744; }
        .text-flat { color: #5c5c7a; }

        .badge-buy { background: #00c85320; color: #00c853; border-radius: 4px; padding: 1px 6px; font-size: 10px; font-weight: 600; }
        .badge-sell { background: #ff174420; color: #ff1744; border-radius: 4px; padding: 1px 6px; font-size: 10px; font-weight: 600; }
        .badge-hold { background: #6366f120; color: #6366f1; border-radius: 4px; padding: 1px 6px; font-size: 10px; font-weight: 600; }

        /* Loading & Error */
        .spinner { width: 18px; height: 18px; border: 2px solid #2a2a3a; border-top-color: #6366f1; border-radius: 50%; animation: spin 0.7s linear infinite; display: inline-block; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .overlay-loading {
            position: absolute; inset: 0; background: rgba(15,15,20,0.8); display: flex;
            align-items: center; justify-content: center; z-index: 20; gap: 8px;
            font-size: 13px; color: #5c5c7a;
        }

        .error-bar {
            background: #ff174415; border: 1px solid #ff174440; border-radius: 6px;
            padding: 8px 12px; font-size: 12px; color: #ff6b6b; margin: 8px 14px;
        }

        /* Toast */
        #toastZone { position: fixed; bottom: 16px; right: 16px; z-index: 9999; display: flex; flex-direction: column; gap: 6px; pointer-events: none; }
        .toast-item {
            padding: 10px 16px; border-radius: 8px; font-size: 13px; font-weight: 500;
            color: white; pointer-events: auto; max-width: 360px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            opacity: 0; transform: translateX(24px); transition: all 0.25s;
        }
        .toast-item.show { opacity: 1; transform: translateX(0); }
        .toast-success { background: #15803d; }
        .toast-error { background: #991b1b; }
        .toast-info { background: #1e40af; }
        .toast-warn { background: #92400e; }

        /* Responsive: collapse to single col on small screens */
        @media (max-width: 1100px) {
            .app-layout {
                grid-template-columns: 1fr;
                grid-template-rows: 48px auto auto auto;
            }
            .panel-left, .panel-right { grid-row: auto; max-height: 300px; }
            .panel-bottom { max-height: 250px; }
            body { overflow: auto; height: auto; }
        }

        /* Tab underline */
        .tab-btn { position: relative; padding: 6px 12px; font-size: 11px; font-weight: 600; color: #5c5c7a; cursor: pointer; background: none; border: none; transition: color 0.15s; }
        .tab-btn:hover { color: #c8c8d8; }
        .tab-btn.active { color: #6366f1; }
        .tab-btn.active::after { content:''; position: absolute; bottom: 0; left: 12px; right: 12px; height: 2px; background: #6366f1; border-radius: 1px; }
    </style>
</head>
<body>
    <div class="app-layout" id="appLayout">
        <!-- â•â•â• HEADER â•â•â• -->
        <header class="app-header panel flex items-center px-4 gap-3 border-b border-term-border" style="z-index:40;">
            <div class="flex items-center gap-2 mr-2">
                <span class="text-lg font-bold text-term-accent">â—†</span>
                <span class="text-sm font-bold text-white tracking-wide">StockPro</span>
            </div>
            <div class="flex-1 max-w-xs relative">
                <input type="text" id="symbolInput" placeholder="æœå°‹è‚¡ç¥¨ (AAPL, 2330.TW)" class="input-dark pl-8 text-xs" style="padding-left:32px;" autocomplete="off">
                <svg class="absolute left-2.5 top-1/2 -translate-y-1/2 w-3.5 h-3.5 text-term-muted" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                <div id="searchDropdown" class="hidden absolute top-full left-0 right-0 mt-1 bg-term-card border border-term-border rounded-lg shadow-2xl z-50 max-h-48 overflow-y-auto"></div>
            </div>
            <!-- Time range -->
            <div class="flex gap-1 ml-2" id="timeRangeBtns">
                <button onclick="changeRange('1M')" class="btn-ghost" data-range="1M">1M</button>
                <button onclick="changeRange('3M')" class="btn-ghost active" data-range="3M">3M</button>
                <button onclick="changeRange('6M')" class="btn-ghost" data-range="6M">6M</button>
                <button onclick="changeRange('1Y')" class="btn-ghost" data-range="1Y">1Y</button>
                <button onclick="changeRange('2Y')" class="btn-ghost" data-range="2Y">2Y</button>
            </div>
            <!-- WS status -->
            <div class="flex items-center gap-2 ml-auto">
                <span id="wsStatusDot" class="w-2 h-2 rounded-full bg-term-red" title="WebSocket"></span>
                <span id="wsStatusText" class="text-xs text-term-muted">é›¢ç·š</span>
                <a href="/backtest" class="btn-ghost text-xs">å›æ¸¬é </a>
                <a href="/compare" class="btn-ghost text-xs">ç­–ç•¥æ¯”è¼ƒ</a>
                <a href="/portfolio" class="btn-ghost text-xs">çµ„åˆåˆ†æ</a>
            </div>
        </header>

        <!-- â•â•â• LEFT PANEL: Watchlist â•â•â• -->
        <aside class="panel-left panel border-r border-term-border">
            <div class="panel-title">è‡ªé¸è‚¡</div>
            <div class="px-3 pb-2">
                <div class="flex gap-1">
                    <input type="text" id="addWatchInput" placeholder="æ–°å¢ä»£ç¢¼" class="input-dark text-xs flex-1" style="padding:5px 8px;">
                    <button onclick="addToWatchlist()" class="btn-accent text-xs" style="padding:5px 10px;">+</button>
                </div>
            </div>
            <div id="watchlist" class="flex-1 overflow-y-auto">
                <!-- Watchlist items -->
            </div>
            <!-- AI Signal Summary -->
            <div class="border-t border-term-border p-3">
                <div class="panel-title" style="padding:0 0 6px;">AI è¨Šè™Ÿ</div>
                <div id="signalDisplay" class="text-center text-xs text-term-muted py-2">è¼‰å…¥ä¸­â€¦</div>
            </div>
        </aside>

        <!-- â•â•â• CENTER: Chart â•â•â• -->
        <main class="panel-center panel relative">
            <!-- Stock info bar -->
            <div class="flex items-center gap-4 px-4 py-2 border-b border-term-border" id="stockBar">
                <span id="dispSymbol" class="text-sm font-bold text-white">AAPL</span>
                <span id="dispName" class="text-xs text-term-muted">-</span>
                <span id="dispPrice" class="mono text-sm font-bold text-white">-</span>
                <span id="dispChange" class="mono text-xs">-</span>
                <span id="dispVolume" class="text-xs text-term-muted ml-auto">Vol: -</span>
                <!-- WS realtime price -->
                <span id="wsRealtimePrice" class="mono text-xs text-term-accent hidden">âš¡ -</span>
            </div>
            <!-- Chart container -->
            <div class="flex-1 relative" id="chartArea">
                <div id="mainChart" class="absolute inset-0"></div>
                <div id="chartLoading" class="overlay-loading hidden"><span class="spinner"></span>è¼‰å…¥åœ–è¡¨ä¸­â€¦</div>
            </div>
            <!-- Sub-indicator selector -->
            <div class="flex items-center gap-1 px-3 py-1 border-t border-term-border">
                <span class="text-xs text-term-muted mr-1">æŒ‡æ¨™:</span>
                <button onclick="toggleIndicator('rsi')" class="btn-ghost active text-xs" id="indRsi" data-ind="rsi">RSI</button>
                <button onclick="toggleIndicator('macd')" class="btn-ghost active text-xs" id="indMacd" data-ind="macd">MACD</button>
                <button onclick="toggleIndicator('ma')" class="btn-ghost active text-xs" id="indMa" data-ind="ma">MA</button>
            </div>
        </main>

        <!-- â•â•â• RIGHT PANEL: Backtest & KPI â•â•â• -->
        <aside class="panel-right panel border-l border-term-border flex flex-col">
            <!-- Tabs -->
            <div class="flex border-b border-term-border">
                <button class="tab-btn active" onclick="switchRightTab('backtest')" id="rtBacktest">å›æ¸¬</button>
                <button class="tab-btn" onclick="switchRightTab('simtrade')" id="rtSimtrade">æ¨¡æ“¬äº¤æ˜“</button>
            </div>

            <!-- Backtest Tab -->
            <div id="rightBacktest" class="flex-1 overflow-y-auto p-3 space-y-3">
                <div>
                    <label class="text-xs text-term-muted mb-1 block">ç­–ç•¥</label>
                    <select id="btStrategy" class="input-dark text-xs" onchange="onStrategyChange()">
                        <option value="ma_crossover">MA Crossover</option>
                        <option value="rsi_reversal">RSI Reversal</option>
                        <option value="macd_signal">MACD Signal</option>
                        <option value="rf">Random Forest ML</option>
                    </select>
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <div>
                        <label class="text-xs text-term-muted mb-1 block">é–‹å§‹</label>
                        <input type="date" id="btStart" class="input-dark text-xs">
                    </div>
                    <div>
                        <label class="text-xs text-term-muted mb-1 block">çµæŸ</label>
                        <input type="date" id="btEnd" class="input-dark text-xs">
                    </div>
                </div>
                <div>
                    <label class="text-xs text-term-muted mb-1 block">åˆå§‹è³‡é‡‘</label>
                    <input type="number" id="btCapital" value="100000" min="1000" step="1000" class="input-dark text-xs">
                </div>
                <!-- Dynamic strategy params -->
                <div id="btParamsPanel" class="hidden space-y-2">
                    <div class="text-xs text-term-accent font-semibold">ç­–ç•¥åƒæ•¸</div>
                    <div id="btParamsContent" class="space-y-2"></div>
                </div>
                <button onclick="runBacktest()" id="btRunBtn" class="btn-accent w-full">
                    â–¶ åŸ·è¡Œå›æ¸¬
                </button>

                <!-- KPI Results -->
                <div id="btResults" class="hidden">
                    <div class="text-xs text-term-accent font-semibold mb-2 mt-1">ç¸¾æ•ˆæ‘˜è¦</div>
                    <div class="grid grid-cols-2 gap-1">
                        <div class="kpi bg-term-bg rounded-lg"><div class="kpi-value" id="kpiReturn">-</div><div class="kpi-label">ç¸½å ±é…¬</div></div>
                        <div class="kpi bg-term-bg rounded-lg"><div class="kpi-value" id="kpiSharpe">-</div><div class="kpi-label">Sharpe</div></div>
                        <div class="kpi bg-term-bg rounded-lg"><div class="kpi-value" id="kpiDrawdown">-</div><div class="kpi-label">æœ€å¤§å›æ’¤</div></div>
                        <div class="kpi bg-term-bg rounded-lg"><div class="kpi-value" id="kpiWinRate">-</div><div class="kpi-label">å‹ç‡</div></div>
                        <div class="kpi bg-term-bg rounded-lg"><div class="kpi-value" id="kpiTrades">-</div><div class="kpi-label">äº¤æ˜“æ•¸</div></div>
                        <div class="kpi bg-term-bg rounded-lg"><div class="kpi-value" id="kpiFinal">-</div><div class="kpi-label">æœ€çµ‚è³‡ç”¢</div></div>
                    </div>
                    <!-- Strategy vs Buy & Hold -->
                    <div class="mt-2 bg-term-bg rounded-lg p-2">
                        <div class="flex justify-between text-xs mb-1">
                            <span class="text-term-muted">ç­–ç•¥</span>
                            <span id="kpiStratReturn" class="font-semibold">-</span>
                        </div>
                        <div class="flex justify-between text-xs">
                            <span class="text-term-muted">Buy & Hold</span>
                            <span id="kpiBHReturn" class="font-semibold">-</span>
                        </div>
                        <div id="kpiComparison" class="text-center text-xs mt-1 font-semibold"></div>
                    </div>
                </div>
            </div>

            <!-- SimTrade Tab -->
            <div id="rightSimtrade" class="flex-1 overflow-y-auto p-3 space-y-3 hidden">
                <div>
                    <label class="text-xs text-term-muted mb-1 block">å¸³æˆ¶</label>
                    <div class="flex gap-1">
                        <select id="simAcctSelect" class="input-dark text-xs flex-1" onchange="loadSimAcctDetail()">
                            <option value="">é¸æ“‡å¸³æˆ¶</option>
                        </select>
                        <button onclick="showCreateAcct()" class="btn-ghost text-xs">+ æ–°å»º</button>
                    </div>
                </div>
                <!-- Create account form (hidden) -->
                <div id="simCreateForm" class="hidden bg-term-bg rounded-lg p-2 space-y-2">
                    <input type="text" id="simNewName" placeholder="å¸³æˆ¶åç¨±" class="input-dark text-xs">
                    <input type="number" id="simNewCash" value="100000" min="1000" step="1000" class="input-dark text-xs">
                    <div class="flex gap-1">
                        <button onclick="createSimAcct()" class="btn-accent text-xs flex-1">å»ºç«‹</button>
                        <button onclick="document.getElementById('simCreateForm').classList.add('hidden')" class="btn-ghost text-xs">å–æ¶ˆ</button>
                    </div>
                </div>
                <!-- Account details -->
                <div id="simAcctDetail" class="hidden space-y-2">
                    <div class="grid grid-cols-2 gap-1">
                        <div class="kpi bg-term-bg rounded-lg"><div class="kpi-value text-sm" id="simCash">-</div><div class="kpi-label">ç¾é‡‘</div></div>
                        <div class="kpi bg-term-bg rounded-lg"><div class="kpi-value text-sm" id="simNetVal">-</div><div class="kpi-label">æ·¨å€¼</div></div>
                    </div>
                    <div id="simPnL" class="text-center text-xs font-semibold"></div>
                    <!-- Positions -->
                    <div id="simPositions" class="text-xs"></div>
                    <!-- Trade form -->
                    <div class="bg-term-bg rounded-lg p-2 space-y-2">
                        <div class="text-xs text-term-accent font-semibold">ä¸‹å–®</div>
                        <input type="text" id="simSymbol" placeholder="è‚¡ç¥¨ä»£ç¢¼" class="input-dark text-xs">
                        <div class="flex gap-1">
                            <select id="simAction" class="input-dark text-xs">
                                <option value="buy">è²·å…¥</option>
                                <option value="sell">è³£å‡º</option>
                            </select>
                            <input type="number" id="simQty" value="10" min="1" class="input-dark text-xs" style="width:70px;">
                        </div>
                        <button onclick="execSimTrade()" class="btn-accent w-full text-xs">åŸ·è¡Œäº¤æ˜“</button>
                    </div>
                </div>
            </div>
        </aside>

        <!-- â•â•â• BOTTOM: Trades + Equity â•â•â• -->
        <section class="panel-bottom panel border-t border-term-border flex flex-col">
            <div class="flex items-center border-b border-term-border">
                <button class="tab-btn active" onclick="switchBottomTab('trades')" id="btTabTrades">äº¤æ˜“è¨˜éŒ„</button>
                <button class="tab-btn" onclick="switchBottomTab('equity')" id="btTabEquity">æ¬Šç›Šæ›²ç·š</button>
                <button class="tab-btn" onclick="switchBottomTab('wf')" id="btTabWF">Walk-Forward</button>
                <div class="ml-auto pr-2 flex gap-1">
                    <span id="tradeCount" class="text-xs text-term-muted"></span>
                    <button onclick="exportCSV()" class="btn-ghost text-xs hidden" id="csvBtn">â¬‡ CSV</button>
                </div>
            </div>
            <!-- Trades -->
            <div id="bottomTrades" class="flex-1 overflow-auto">
                <table class="trade-tbl">
                    <thead>
                        <tr>
                            <th onclick="sortTrades('entry_date')">é€²å ´æ—¥ <span id="s_entry_date" class="text-term-muted">â†•</span></th>
                            <th onclick="sortTrades('exit_date')">å‡ºå ´æ—¥ <span id="s_exit_date">â†•</span></th>
                            <th>é€²å ´åƒ¹</th>
                            <th>å‡ºå ´åƒ¹</th>
                            <th>è‚¡æ•¸</th>
                            <th onclick="sortTrades('pnl')">æç›Š <span id="s_pnl">â†•</span></th>
                            <th onclick="sortTrades('pnl_percent')">æç›Š% <span id="s_pnl_percent">â†•</span></th>
                        </tr>
                    </thead>
                    <tbody id="tradeBody"></tbody>
                </table>
                <div id="tradeEmpty" class="text-center text-xs text-term-muted py-8">åŸ·è¡Œå›æ¸¬å¾Œé€™è£¡æœƒé¡¯ç¤ºäº¤æ˜“æ˜ç´°</div>
            </div>
            <!-- Equity -->
            <div id="bottomEquity" class="flex-1 hidden relative">
                <div class="absolute top-1 right-2 flex gap-1 z-10">
                    <button onclick="eqZoom('1M')" class="btn-ghost text-xs">1M</button>
                    <button onclick="eqZoom('3M')" class="btn-ghost text-xs">3M</button>
                    <button onclick="eqZoom('All')" class="btn-ghost text-xs active">All</button>
                </div>
                <div id="equityChart" class="absolute inset-0"></div>
            </div>
            <!-- Walk-Forward -->
            <div id="bottomWF" class="flex-1 hidden overflow-auto p-3">
                <div id="wfEmpty" class="text-center text-xs text-term-muted py-8">å›æ¸¬çµæœåŒ…å« Walk-Forward æ™‚æœƒé¡¯ç¤ºåœ¨æ­¤</div>
                <div id="wfContent" class="hidden space-y-3">
                    <div class="grid grid-cols-4 gap-2">
                        <div class="kpi bg-term-bg rounded-lg"><div class="kpi-value text-sm" id="wfFolds">-</div><div class="kpi-label">æŠ˜æ•¸</div></div>
                        <div class="kpi bg-term-bg rounded-lg"><div class="kpi-value text-sm" id="wfAvg">-</div><div class="kpi-label">å¹³å‡å ±é…¬</div></div>
                        <div class="kpi bg-term-bg rounded-lg"><div class="kpi-value text-sm" id="wfStd">-</div><div class="kpi-label">æ³¢å‹• Ïƒ</div></div>
                        <div class="kpi bg-term-bg rounded-lg"><div class="kpi-value text-sm" id="wfBestWorst">-</div><div class="kpi-label">æœ€ä½³/æœ€å·®</div></div>
                    </div>
                    <canvas id="wfBarChart" style="width:100%;height:120px;"></canvas>
                </div>
            </div>
        </section>
    </div>

    <!-- Toast zone -->
    <div id="toastZone"></div>

    <script>
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // State
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    let currentSymbol = 'AAPL';
    let currentRange = '3M';
    let mainChart, candleSeries, volumeSeries, ma5Series, ma20Series, ma60Series;
    let equityChart, equitySeries, buyHoldSeries;
    let backtestTrades = [];
    let backtestEquityCurve = [];
    let sortState = { field: null, dir: 'asc' };
    let strategiesCache = null;
    let showIndicators = { rsi: true, macd: true, ma: true };
    let _ws = null, _wsSymbol = null, _wsTimer = null, _wsDelay = 1000;
    const DEFAULT_WATCHLIST = ['AAPL', 'NVDA', 'TSLA', 'MSFT', 'GOOG', '2330.TW'];

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Init
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    window.addEventListener('load', () => {
        initCharts();
        initDates();
        initWatchlist();
        loadStock('AAPL');
        loadSimAccounts();
    });

    document.getElementById('symbolInput').addEventListener('keydown', e => {
        if (e.key === 'Enter') {
            const v = e.target.value.trim().toUpperCase();
            if (v) loadStock(v);
        }
    });

    // Search autocomplete
    let searchTimeout;
    document.getElementById('symbolInput').addEventListener('input', e => {
        clearTimeout(searchTimeout);
        const q = e.target.value.trim();
        if (q.length < 1) { document.getElementById('searchDropdown').classList.add('hidden'); return; }
        searchTimeout = setTimeout(() => searchSymbol(q), 300);
    });

    async function searchSymbol(q) {
        try {
            const resp = await fetch(`/api/search?q=${encodeURIComponent(q)}`);
            if (!resp.ok) return;
            const data = await resp.json();
            const dd = document.getElementById('searchDropdown');
            if (!data.results || data.results.length === 0) { dd.classList.add('hidden'); return; }
            dd.innerHTML = data.results.slice(0, 8).map(r => `
                <div class="px-3 py-2 hover:bg-term-hover cursor-pointer text-xs flex justify-between" onclick="selectSearchResult('${r.symbol}')">
                    <span class="font-semibold text-white">${r.symbol}</span>
                    <span class="text-term-muted truncate ml-2">${r.name || ''}</span>
                </div>
            `).join('');
            dd.classList.remove('hidden');
        } catch(e) {}
    }

    function selectSearchResult(symbol) {
        document.getElementById('searchDropdown').classList.add('hidden');
        document.getElementById('symbolInput').value = symbol;
        loadStock(symbol);
    }

    document.addEventListener('click', e => {
        if (!e.target.closest('#symbolInput') && !e.target.closest('#searchDropdown'))
            document.getElementById('searchDropdown').classList.add('hidden');
    });

    function initDates() {
        const today = new Date();
        const ago = new Date(today);
        ago.setFullYear(today.getFullYear() - 1);
        document.getElementById('btEnd').valueAsDate = today;
        document.getElementById('btStart').valueAsDate = ago;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Watchlist
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function getWatchlist() {
        try { return JSON.parse(localStorage.getItem('watchlist')) || DEFAULT_WATCHLIST; }
        catch { return DEFAULT_WATCHLIST; }
    }
    function saveWatchlist(list) { localStorage.setItem('watchlist', JSON.stringify(list)); }

    function initWatchlist() {
        const list = getWatchlist();
        renderWatchlist(list);
        list.forEach(s => fetchWatchlistPrice(s));
    }

    function renderWatchlist(list) {
        const container = document.getElementById('watchlist');
        container.innerHTML = list.map(s => `
            <div class="wl-item ${s === currentSymbol ? 'active' : ''}" id="wl-${s}" onclick="loadStock('${s}')">
                <div>
                    <div class="wl-symbol">${s}</div>
                    <div class="wl-name" id="wln-${s}">-</div>
                </div>
                <div class="wl-price mono" id="wlp-${s}">-</div>
                <div class="wl-change mono" id="wlc-${s}">-</div>
            </div>
        `).join('');
    }

    async function fetchWatchlistPrice(symbol) {
        try {
            const resp = await fetch(`/api/stock/${symbol}?range=1M`);
            if (!resp.ok) return;
            const data = await resp.json();
            const info = data.info || {};
            const last = data.data?.length > 0 ? data.data[data.data.length - 1] : null;
            const nameEl = document.getElementById(`wln-${symbol}`);
            const priceEl = document.getElementById(`wlp-${symbol}`);
            const changeEl = document.getElementById(`wlc-${symbol}`);
            if (nameEl) nameEl.textContent = (info.name || '').substring(0, 15);
            if (priceEl && last) priceEl.textContent = last.close.toFixed(2);
            if (changeEl && info.change !== undefined && last) {
                const pct = ((info.change / (last.close - info.change)) * 100);
                changeEl.textContent = (pct >= 0 ? '+' : '') + pct.toFixed(2) + '%';
                changeEl.className = 'wl-change mono ' + (pct >= 0 ? 'text-up' : 'text-down');
            }
        } catch(e) {}
    }

    function addToWatchlist() {
        const input = document.getElementById('addWatchInput');
        const s = input.value.trim().toUpperCase();
        if (!s) return;
        const list = getWatchlist();
        if (!list.includes(s)) { list.unshift(s); saveWatchlist(list); }
        renderWatchlist(list);
        fetchWatchlistPrice(s);
        input.value = '';
    }

    document.getElementById('addWatchInput').addEventListener('keydown', e => {
        if (e.key === 'Enter') addToWatchlist();
    });

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Charts Init
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function initCharts() {
        const el = document.getElementById('mainChart');
        mainChart = LightweightCharts.createChart(el, {
            layout: { background: { color: '#16161e' }, textColor: '#5c5c7a', fontFamily: 'Inter, sans-serif', fontSize: 11 },
            grid: { vertLines: { color: '#1e1e2a' }, horzLines: { color: '#1e1e2a' } },
            crosshair: { mode: LightweightCharts.CrosshairMode.Normal },
            rightPriceScale: { borderColor: '#2a2a3a' },
            timeScale: { borderColor: '#2a2a3a', timeVisible: true },
            width: el.clientWidth, height: el.clientHeight,
        });

        candleSeries = mainChart.addCandlestickSeries({
            upColor: '#00c853', downColor: '#ff1744',
            borderUpColor: '#00c853', borderDownColor: '#ff1744',
            wickUpColor: '#00c85380', wickDownColor: '#ff174480',
        });

        volumeSeries = mainChart.addHistogramSeries({
            color: '#5c5c7a40', priceFormat: { type: 'volume' }, priceScaleId: 'vol',
        });
        mainChart.priceScale('vol').applyOptions({ scaleMargins: { top: 0.85, bottom: 0 } });

        ma5Series = mainChart.addLineSeries({ color: '#3b82f6', lineWidth: 1, title: 'MA5' });
        ma20Series = mainChart.addLineSeries({ color: '#f59e0b', lineWidth: 1, title: 'MA20' });
        ma60Series = mainChart.addLineSeries({ color: '#ef4444', lineWidth: 1, title: 'MA60' });

        // Resize
        const ro = new ResizeObserver(() => {
            mainChart.applyOptions({ width: el.clientWidth, height: el.clientHeight });
        });
        ro.observe(el);
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Load Stock
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    async function loadStock(symbol) {
        currentSymbol = symbol;
        document.getElementById('symbolInput').value = symbol;
        document.getElementById('chartLoading').classList.remove('hidden');

        // Update watchlist active state
        document.querySelectorAll('.wl-item').forEach(el => el.classList.remove('active'));
        const wlEl = document.getElementById(`wl-${symbol}`);
        if (wlEl) wlEl.classList.add('active');

        // Auto-fill sim trade symbol
        const simSym = document.getElementById('simSymbol');
        if (simSym) simSym.value = symbol;

        try {
            const resp = await fetch(`/api/stock/${symbol}?range=${currentRange}`);
            if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
            const data = await resp.json();
            updateStockBar(data);
            updateMainChart(data);
            loadPrediction(symbol);
            wsAttach(symbol);
        } catch(e) {
            toast(`è¼‰å…¥ ${symbol} å¤±æ•—ï¼š${e.message}`, 'error');
        } finally {
            document.getElementById('chartLoading').classList.add('hidden');
        }
    }

    function updateStockBar(data) {
        const info = data.info || {};
        const last = data.data?.length > 0 ? data.data[data.data.length - 1] : null;
        document.getElementById('dispSymbol').textContent = info.symbol || currentSymbol;
        document.getElementById('dispName').textContent = info.name || '';
        if (last) {
            document.getElementById('dispPrice').textContent = '$' + last.close.toFixed(2);
            if (info.change !== undefined) {
                const pct = ((info.change / (last.close - info.change)) * 100);
                const el = document.getElementById('dispChange');
                el.textContent = (pct >= 0 ? '+' : '') + pct.toFixed(2) + '%';
                el.className = 'mono text-xs ' + (pct >= 0 ? 'text-up' : 'text-down');
            }
        }
    }

    function updateMainChart(data) {
        const chartData = data.data || [];
        candleSeries.setData(chartData.map(d => ({ time: d.date, open: d.open, high: d.high, low: d.low, close: d.close })));
        volumeSeries.setData(chartData.map(d => ({ time: d.date, value: d.volume, color: d.close >= d.open ? '#00c85330' : '#ff174430' })));

        if (showIndicators.ma && data.indicators) {
            if (data.indicators.ma5) ma5Series.setData(data.indicators.ma5.map((v,i)=>({time:chartData[i].date,value:v})).filter(d=>d.value!==null));
            if (data.indicators.ma20) ma20Series.setData(data.indicators.ma20.map((v,i)=>({time:chartData[i].date,value:v})).filter(d=>d.value!==null));
            if (data.indicators.ma60) ma60Series.setData(data.indicators.ma60.map((v,i)=>({time:chartData[i].date,value:v})).filter(d=>d.value!==null));
        } else {
            ma5Series.setData([]); ma20Series.setData([]); ma60Series.setData([]);
        }

        mainChart.timeScale().fitContent();
    }

    function toggleIndicator(name) {
        showIndicators[name] = !showIndicators[name];
        const btn = document.getElementById('ind' + name.charAt(0).toUpperCase() + name.slice(1));
        btn.classList.toggle('active', showIndicators[name]);
        loadStock(currentSymbol); // reload to apply
    }

    function changeRange(range) {
        currentRange = range;
        document.querySelectorAll('#timeRangeBtns .btn-ghost').forEach(b => b.classList.remove('active'));
        document.querySelector(`[data-range="${range}"]`).classList.add('active');
        loadStock(currentSymbol);
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // AI Prediction
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    async function loadPrediction(symbol) {
        const el = document.getElementById('signalDisplay');
        el.innerHTML = '<span class="spinner" style="width:14px;height:14px;"></span>';
        try {
            const resp = await fetch(`/api/stock/${symbol}/predict`);
            if (!resp.ok) throw new Error();
            const p = await resp.json();
            const signal = p.signal || 'HOLD';
            const conf = (p.confidence || 0).toFixed(1);
            const badge = signal === 'BUY' ? 'badge-buy' : signal === 'SELL' ? 'badge-sell' : 'badge-hold';
            const icon = signal === 'BUY' ? 'ğŸ“ˆ' : signal === 'SELL' ? 'ğŸ“‰' : 'â¸';
            el.innerHTML = `
                <span class="${badge} text-sm">${icon} ${signal}</span>
                <span class="ml-2 text-term-text">${conf}%</span>
                <div class="text-term-muted mt-1" style="font-size:10px;line-height:1.4;">${p.reason || ''}</div>
            `;
        } catch(e) {
            el.innerHTML = '<span class="text-term-muted">ç„¡æ³•è¼‰å…¥</span>';
        }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // WebSocket
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function wsSetStatus(state) {
        const dot = document.getElementById('wsStatusDot');
        const txt = document.getElementById('wsStatusText');
        if (state === 'connected') { dot.style.background='#00c853'; txt.textContent='å³æ™‚'; }
        else if (state === 'reconnecting') { dot.style.background='#f59e0b'; txt.textContent='é‡é€£â€¦'; }
        else { dot.style.background='#ff1744'; txt.textContent='é›¢ç·š'; }
    }

    function wsAttach(symbol) {
        _wsSymbol = symbol; _wsDelay = 1000;
        wsOpen(symbol);
    }

    function wsOpen(symbol) {
        if (_ws) { _ws.onclose = null; _ws.close(); _ws = null; }
        clearTimeout(_wsTimer);
        const proto = location.protocol === 'https:' ? 'wss' : 'ws';
        wsSetStatus('reconnecting');
        _ws = new WebSocket(`${proto}://${location.host}/ws/price/${encodeURIComponent(symbol)}`);
        _ws.onopen = () => { _wsDelay = 1000; wsSetStatus('connected'); };
        _ws.onmessage = e => {
            try {
                const d = JSON.parse(e.data);
                if (d.error) return;
                const rt = document.getElementById('wsRealtimePrice');
                rt.classList.remove('hidden');
                rt.textContent = 'âš¡ ' + (d.price != null ? d.price.toFixed(2) : '-');
            } catch(e) {}
        };
        _ws.onerror = () => {};
        _ws.onclose = ev => {
            _ws = null;
            if (ev.code === 1008) { wsSetStatus('disconnected'); return; }
            wsSetStatus('reconnecting');
            _wsTimer = setTimeout(() => { if (_wsSymbol) wsOpen(_wsSymbol); }, Math.min(_wsDelay, 30000));
            _wsDelay = Math.min(_wsDelay * 2, 30000);
        };
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Right Panel Tabs
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function switchRightTab(tab) {
        document.getElementById('rightBacktest').classList.toggle('hidden', tab !== 'backtest');
        document.getElementById('rightSimtrade').classList.toggle('hidden', tab !== 'simtrade');
        document.getElementById('rtBacktest').classList.toggle('active', tab === 'backtest');
        document.getElementById('rtSimtrade').classList.toggle('active', tab === 'simtrade');
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Backtest
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    async function onStrategyChange() {
        const name = document.getElementById('btStrategy').value;
        const panel = document.getElementById('btParamsPanel');
        const content = document.getElementById('btParamsContent');
        try {
            if (!strategiesCache) {
                const resp = await fetch('/api/backtest/strategies');
                const data = await resp.json();
                strategiesCache = data.strategies || [];
            }
            const strat = strategiesCache.find(s => s.name === name);
            const pRaw = strat?.parameters;
            if (!pRaw || Object.keys(pRaw).length === 0) { panel.classList.add('hidden'); return; }
            const arr = Array.isArray(pRaw) ? pRaw : Object.entries(pRaw).map(([n,s])=>({name:n,...s}));
            panel.classList.remove('hidden');
            content.innerHTML = arr.map(p => `
                <div>
                    <label class="text-xs text-term-muted block mb-0.5">${p.description||p.name} <span class="text-term-accent">(${p.min}â€“${p.max})</span></label>
                    <input type="number" id="bp_${p.name}" value="${p.default}" min="${p.min}" max="${p.max}" step="${p.step||(p.type==='float'?0.05:1)}" class="input-dark text-xs">
                </div>
            `).join('');
        } catch(e) { panel.classList.add('hidden'); }
    }

    function getBtParams() {
        const params = {};
        document.querySelectorAll('[id^="bp_"]').forEach(el => {
            params[el.id.replace('bp_', '')] = parseFloat(el.value);
        });
        return params;
    }

    async function runBacktest() {
        const btn = document.getElementById('btRunBtn');
        const start = document.getElementById('btStart').value;
        const end = document.getElementById('btEnd').value;
        const capital = parseFloat(document.getElementById('btCapital').value);
        const strategy = document.getElementById('btStrategy').value;

        if (!start || !end) { toast('è«‹é¸æ“‡æ—¥æœŸç¯„åœ', 'warn'); return; }
        if (new Date(start) >= new Date(end)) { toast('é–‹å§‹æ—¥æœŸéœ€æ—©æ–¼çµæŸæ—¥æœŸ', 'warn'); return; }

        btn.disabled = true;
        btn.textContent = 'â³ å›æ¸¬ä¸­â€¦';

        try {
            const params = getBtParams();
            const resp = await fetch('/api/backtest', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    symbol: currentSymbol, strategy, start_date: start, end_date: end,
                    initial_capital: capital,
                    parameters: Object.keys(params).length > 0 ? params : undefined,
                }),
            });
            if (!resp.ok) {
                const err = await resp.json().catch(()=>({}));
                throw new Error(err.detail || err.error || `HTTP ${resp.status}`);
            }
            const result = await resp.json();
            displayBtResults(result);
            toast('å›æ¸¬å®Œæˆï¼', 'success');
        } catch(e) {
            toast(`å›æ¸¬å¤±æ•—ï¼š${e.message}`, 'error');
        } finally {
            btn.disabled = false;
            btn.textContent = 'â–¶ åŸ·è¡Œå›æ¸¬';
        }
    }

    function displayBtResults(result) {
        const m = result.data?.performance || {};
        const b = result.data?.benchmark || {};
        document.getElementById('btResults').classList.remove('hidden');

        const ret = m.total_return || 0;
        setKPI('kpiReturn', `${ret >= 0 ? '+' : ''}${ret.toFixed(2)}%`, ret >= 0 ? 'text-up' : 'text-down');
        setKPI('kpiSharpe', (m.sharpe_ratio || 0).toFixed(3), 'text-term-text');
        setKPI('kpiDrawdown', `${(m.max_drawdown || 0).toFixed(2)}%`, 'text-down');
        setKPI('kpiWinRate', `${(m.win_rate || 0).toFixed(1)}%`, 'text-term-text');
        setKPI('kpiTrades', m.total_trades || 0, 'text-term-text');
        const fv = m.final_portfolio_value || 0;
        setKPI('kpiFinal', fv > 0 ? `$${fv.toLocaleString('en',{maximumFractionDigits:0})}` : '-', 'text-term-text');

        const sr = m.total_return || 0;
        const bh = b.total_return || 0;
        const sEl = document.getElementById('kpiStratReturn');
        sEl.textContent = `${sr >= 0?'+':''}${sr.toFixed(2)}%`;
        sEl.className = 'font-semibold ' + (sr >= 0 ? 'text-up' : 'text-down');
        const bEl = document.getElementById('kpiBHReturn');
        bEl.textContent = `${bh >= 0?'+':''}${bh.toFixed(2)}%`;
        bEl.className = 'font-semibold ' + (bh >= 0 ? 'text-up' : 'text-down');
        const diff = sr - bh;
        const cmpEl = document.getElementById('kpiComparison');
        cmpEl.textContent = diff >= 0 ? `ğŸ‰ ç­–ç•¥è´ ${diff.toFixed(2)}%` : `ğŸ“‰ è½å¾Œ ${Math.abs(diff).toFixed(2)}%`;
        cmpEl.className = 'text-center text-xs mt-1 font-semibold ' + (diff >= 0 ? 'text-up' : 'text-down');

        // Trades
        backtestTrades = result.data?.trades || [];
        displayTrades(backtestTrades);

        // Equity curve
        backtestEquityCurve = result.data?.equity_curve || [];
        if (backtestEquityCurve.length > 0) displayEquityCurve(backtestEquityCurve);

        // Walk-Forward
        if (result.data?.folds?.length > 0) displayWF(result.data.folds);
        else { document.getElementById('wfContent').classList.add('hidden'); document.getElementById('wfEmpty').classList.remove('hidden'); }
    }

    function setKPI(id, value, cls) {
        const el = document.getElementById(id);
        el.textContent = value;
        el.className = 'kpi-value ' + cls;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Trade Table
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function displayTrades(trades) {
        const tbody = document.getElementById('tradeBody');
        const empty = document.getElementById('tradeEmpty');
        const cnt = document.getElementById('tradeCount');
        const csvBtn = document.getElementById('csvBtn');
        cnt.textContent = `${trades.length} ç­†`;
        csvBtn.classList.toggle('hidden', trades.length === 0);
        if (trades.length === 0) { tbody.innerHTML = ''; empty.classList.remove('hidden'); return; }
        empty.classList.add('hidden');
        renderTradeRows(trades);
    }

    function renderTradeRows(trades) {
        document.getElementById('tradeBody').innerHTML = trades.map(t => {
            const pnl = t.pnl || 0;
            const cls = pnl >= 0 ? 'text-up' : 'text-down';
            const sign = pnl >= 0 ? '+' : '';
            return `<tr>
                <td>${t.entry_date||'-'}</td>
                <td>${t.exit_date||'-'}</td>
                <td class="text-right">$${(t.entry_price||0).toFixed(2)}</td>
                <td class="text-right">$${(t.exit_price||0).toFixed(2)}</td>
                <td class="text-right">${t.shares||0}</td>
                <td class="text-right ${cls} font-semibold">${sign}$${pnl.toFixed(2)}</td>
                <td class="text-right ${cls} font-semibold">${sign}${(t.pnl_percent||0).toFixed(2)}%</td>
            </tr>`;
        }).join('');
    }

    function sortTrades(field) {
        if (!backtestTrades.length) return;
        if (sortState.field === field) sortState.dir = sortState.dir === 'asc' ? 'desc' : 'asc';
        else { sortState.field = field; sortState.dir = 'asc'; }
        document.querySelectorAll('[id^="s_"]').forEach(e => e.textContent = 'â†•');
        const ind = document.getElementById(`s_${field}`);
        if (ind) ind.textContent = sortState.dir === 'asc' ? 'â†‘' : 'â†“';
        const sorted = [...backtestTrades].sort((a,b) => {
            let va = a[field], vb = b[field];
            if (typeof va === 'string') return sortState.dir === 'asc' ? va.localeCompare(vb) : vb.localeCompare(va);
            return sortState.dir === 'asc' ? va - vb : vb - va;
        });
        renderTradeRows(sorted);
    }

    function exportCSV() {
        if (!backtestTrades.length) return;
        const h = ['é€²å ´æ—¥æœŸ','å‡ºå ´æ—¥æœŸ','é€²å ´åƒ¹','å‡ºå ´åƒ¹','è‚¡æ•¸','æç›Š','æç›Š%'];
        const rows = backtestTrades.map(t => [t.entry_date||'',t.exit_date||'',(t.entry_price||0).toFixed(2),(t.exit_price||0).toFixed(2),t.shares||0,(t.pnl||0).toFixed(2),(t.pnl_percent||0).toFixed(2)]);
        const csv = [h,...rows].map(r=>r.join(',')).join('\n');
        const blob = new Blob(['\uFEFF'+csv],{type:'text/csv;charset=utf-8;'});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
        a.download = `trades_${currentSymbol}_${new Date().toISOString().split('T')[0]}.csv`;
        a.click();
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Bottom Tabs
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function switchBottomTab(tab) {
        ['trades','equity','wf'].forEach(t => {
            document.getElementById('bottom' + t.charAt(0).toUpperCase() + t.slice(1) + (t==='wf'?'':'s'||'')).classList.toggle('hidden', t !== tab);
        });
        // Fix: manual toggle
        document.getElementById('bottomTrades').classList.toggle('hidden', tab !== 'trades');
        document.getElementById('bottomEquity').classList.toggle('hidden', tab !== 'equity');
        document.getElementById('bottomWF').classList.toggle('hidden', tab !== 'wf');
        document.getElementById('btTabTrades').classList.toggle('active', tab === 'trades');
        document.getElementById('btTabEquity').classList.toggle('active', tab === 'equity');
        document.getElementById('btTabWF').classList.toggle('active', tab === 'wf');

        if (tab === 'equity' && equityChart) {
            setTimeout(() => {
                const el = document.getElementById('equityChart');
                equityChart.applyOptions({ width: el.clientWidth, height: el.clientHeight });
                equityChart.timeScale().fitContent();
            }, 50);
        }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Equity Chart
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function displayEquityCurve(curve) {
        const el = document.getElementById('equityChart');
        if (!equityChart) {
            equityChart = LightweightCharts.createChart(el, {
                layout: { background: { color: '#16161e' }, textColor: '#5c5c7a', fontFamily: 'Inter', fontSize: 11 },
                grid: { vertLines: { color: '#1e1e2a' }, horzLines: { color: '#1e1e2a' } },
                rightPriceScale: { borderColor: '#2a2a3a' },
                timeScale: { borderColor: '#2a2a3a' },
                width: el.clientWidth, height: el.clientHeight,
            });
            equitySeries = equityChart.addLineSeries({ color: '#6366f1', lineWidth: 2, title: 'ç­–ç•¥' });
            buyHoldSeries = equityChart.addLineSeries({ color: '#5c5c7a', lineWidth: 1, lineStyle: 2, title: 'B&H' });
            new ResizeObserver(() => {
                equityChart.applyOptions({ width: el.clientWidth, height: el.clientHeight });
            }).observe(el);
        }
        equitySeries.setData(curve.map(p => ({ time: p.date, value: p.value })));
        if (curve.some(p => p.benchmark != null)) {
            buyHoldSeries.setData(curve.filter(p => p.benchmark != null).map(p => ({ time: p.date, value: p.benchmark })));
        }
        equityChart.timeScale().fitContent();
        // Auto switch to equity tab
        switchBottomTab('equity');
    }

    function eqZoom(range) {
        if (!equityChart || !backtestEquityCurve.length) return;
        document.querySelectorAll('#bottomEquity .btn-ghost').forEach(b=>b.classList.remove('active'));
        event.target.classList.add('active');
        if (range === 'All') { equityChart.timeScale().fitContent(); return; }
        const months = range === '1M' ? 1 : 3;
        const last = backtestEquityCurve[backtestEquityCurve.length - 1]?.date;
        if (!last) return;
        const endD = new Date(last); const startD = new Date(last); startD.setMonth(startD.getMonth() - months);
        try { equityChart.timeScale().setVisibleRange({ from: startD.toISOString().split('T')[0], to: endD.toISOString().split('T')[0] }); } catch(e) {}
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Walk-Forward
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function displayWF(folds) {
        document.getElementById('wfContent').classList.remove('hidden');
        document.getElementById('wfEmpty').classList.add('hidden');
        const rets = folds.map(f => f.metrics?.return || 0);
        const avg = rets.reduce((a,b)=>a+b,0) / rets.length;
        const std = Math.sqrt(rets.map(r=>(r-avg)**2).reduce((a,b)=>a+b,0)/rets.length);
        document.getElementById('wfFolds').textContent = folds.length;
        const avgEl = document.getElementById('wfAvg');
        avgEl.textContent = `${avg>=0?'+':''}${avg.toFixed(2)}%`;
        avgEl.className = 'kpi-value text-sm ' + (avg >= 0 ? 'text-up' : 'text-down');
        document.getElementById('wfStd').textContent = `Â±${std.toFixed(2)}%`;
        const best = Math.max(...rets), worst = Math.min(...rets);
        document.getElementById('wfBestWorst').innerHTML = `<span class="${best>=0?'text-up':'text-down'}">${best.toFixed(1)}%</span> / <span class="${worst>=0?'text-up':'text-down'}">${worst.toFixed(1)}%</span>`;
        drawWFBar(folds);
        switchBottomTab('wf');
    }

    function drawWFBar(folds) {
        const canvas = document.getElementById('wfBarChart');
        if (!canvas) return;
        const dpr = window.devicePixelRatio || 1;
        const W = canvas.offsetWidth || 600, H = parseInt(canvas.style.height) || 120;
        canvas.width = W * dpr; canvas.height = H * dpr;
        canvas.style.width = W + 'px'; canvas.style.height = H + 'px';
        const ctx = canvas.getContext('2d'); ctx.scale(dpr, dpr);
        ctx.fillStyle = '#0f0f14'; ctx.fillRect(0,0,W,H);
        const vals = folds.map(f => f.metrics?.return || 0);
        const maxV = Math.max(...vals, 0.5), minV = Math.min(...vals, -0.5), range = maxV - minV || 1;
        const pad = { l:40, r:10, t:10, b:24 };
        const cW = W-pad.l-pad.r, cH = H-pad.t-pad.b;
        const zeroY = pad.t + cH * (maxV / range);
        ctx.strokeStyle='#2a2a3a'; ctx.lineWidth=0.5; ctx.setLineDash([3,3]);
        ctx.beginPath(); ctx.moveTo(pad.l,zeroY); ctx.lineTo(W-pad.r,zeroY); ctx.stroke(); ctx.setLineDash([]);
        const step = cW / vals.length, barW = Math.max(4, step*0.6);
        vals.forEach((v,i) => {
            const x = pad.l + i*step + (step-barW)/2;
            const barH = Math.abs(v)/range*cH;
            const y = v >= 0 ? zeroY-barH : zeroY;
            ctx.fillStyle = v >= 0 ? '#00c853' : '#ff1744';
            ctx.fillRect(x,y,barW,Math.max(1,barH));
            ctx.fillStyle='#5c5c7a'; ctx.font='9px Inter'; ctx.textAlign='center';
            ctx.fillText(`F${i+1}`, x+barW/2, H-pad.b+12);
        });
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Simulated Trading
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    async function loadSimAccounts() {
        try {
            const resp = await fetch('/api/sim/accounts');
            if (!resp.ok) return;
            const data = await resp.json();
            const sel = document.getElementById('simAcctSelect');
            sel.innerHTML = '<option value="">é¸æ“‡å¸³æˆ¶</option>' + (data.accounts||[]).map(a => `<option value="${a.id}">${a.name}</option>`).join('');
        } catch(e) {}
    }

    function showCreateAcct() { document.getElementById('simCreateForm').classList.toggle('hidden'); }

    async function createSimAcct() {
        const name = document.getElementById('simNewName').value.trim();
        const cash = parseFloat(document.getElementById('simNewCash').value);
        if (!name) { toast('è«‹è¼¸å…¥å¸³æˆ¶åç¨±', 'warn'); return; }
        try {
            const resp = await fetch('/api/sim/accounts', {
                method: 'POST', headers: {'Content-Type':'application/json'},
                body: JSON.stringify({ name, initial_cash: cash })
            });
            if (!resp.ok) { const e = await resp.json(); throw new Error(e.detail||'å¤±æ•—'); }
            toast('å¸³æˆ¶å»ºç«‹æˆåŠŸ', 'success');
            document.getElementById('simCreateForm').classList.add('hidden');
            loadSimAccounts();
        } catch(e) { toast(e.message, 'error'); }
    }

    async function loadSimAcctDetail() {
        const id = document.getElementById('simAcctSelect').value;
        if (!id) { document.getElementById('simAcctDetail').classList.add('hidden'); return; }
        try {
            const resp = await fetch(`/api/sim/accounts/${id}`);
            if (!resp.ok) throw new Error();
            const acct = await resp.json();
            document.getElementById('simAcctDetail').classList.remove('hidden');
            document.getElementById('simCash').textContent = '$' + acct.cash.toLocaleString();
            document.getElementById('simNetVal').textContent = '$' + acct.net_value.toLocaleString();
            const pnlEl = document.getElementById('simPnL');
            const pnl = acct.total_pnl || 0;
            pnlEl.textContent = `${pnl>=0?'+':''}$${pnl.toLocaleString()} (${(acct.total_pnl_percent||0).toFixed(2)}%)`;
            pnlEl.className = 'text-center text-xs font-semibold ' + (pnl >= 0 ? 'text-up' : 'text-down');
            // Positions
            const posEl = document.getElementById('simPositions');
            if (!acct.positions?.length) {
                posEl.innerHTML = '<div class="text-term-muted text-center py-2">ç„¡æŒå€‰</div>';
            } else {
                posEl.innerHTML = acct.positions.map(p => `
                    <div class="flex justify-between py-1 border-b border-term-border">
                        <span class="font-semibold">${p.symbol}</span>
                        <span>${p.quantity}è‚¡ @ $${p.avg_cost.toFixed(2)}</span>
                        <span class="${p.pnl>=0?'text-up':'text-down'} font-semibold">${p.pnl>=0?'+':''}$${p.pnl.toFixed(2)}</span>
                    </div>
                `).join('');
            }
        } catch(e) { toast('è¼‰å…¥å¸³æˆ¶å¤±æ•—', 'error'); }
    }

    async function execSimTrade() {
        const acctId = document.getElementById('simAcctSelect').value;
        const symbol = document.getElementById('simSymbol').value.trim().toUpperCase();
        const action = document.getElementById('simAction').value;
        const qty = parseInt(document.getElementById('simQty').value);
        if (!acctId) { toast('è«‹é¸æ“‡å¸³æˆ¶', 'warn'); return; }
        if (!symbol) { toast('è«‹è¼¸å…¥è‚¡ç¥¨ä»£ç¢¼', 'warn'); return; }
        try {
            const resp = await fetch(`/api/sim/accounts/${acctId}/trade`, {
                method: 'POST', headers: {'Content-Type':'application/json'},
                body: JSON.stringify({ symbol, action, quantity: qty })
            });
            if (!resp.ok) { const e = await resp.json(); throw new Error(e.detail||'äº¤æ˜“å¤±æ•—'); }
            const r = await resp.json();
            toast(`${r.action==='BUY'?'è²·å…¥':'è³£å‡º'} ${r.quantity}è‚¡ ${r.symbol} @ $${r.price.toFixed(2)}`, 'success');
            loadSimAcctDetail();
        } catch(e) { toast(e.message, 'error'); }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Toast
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function toast(msg, type='info', dur=3500) {
        const zone = document.getElementById('toastZone');
        const el = document.createElement('div');
        el.className = `toast-item toast-${type}`;
        const icons = { success:'âœ…', error:'âŒ', info:'â„¹ï¸', warn:'âš ï¸' };
        el.textContent = `${icons[type]||'â„¹ï¸'} ${msg}`;
        zone.appendChild(el);
        requestAnimationFrame(()=>requestAnimationFrame(()=>el.classList.add('show')));
        setTimeout(()=>{ el.classList.remove('show'); setTimeout(()=>el.remove(), 300); }, dur);
    }
    window.showToast = toast;

    // Service Worker
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/static/service-worker.js').catch(()=>{});
    }
    </script>
</body>
</html>
